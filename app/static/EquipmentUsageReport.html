<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipment Usage Report</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <script src="/static/config.js"></script>
    <link rel="stylesheet" href="/static/mobile-responsive.css">
    <link rel="stylesheet" href="/static/modern-theme.css">
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #80ff80;
            padding: 20px;
        }
        h2 {
            text-align: center;
            border-bottom: 1px solid #80ff80;
            padding-bottom: 10px;
        }
        .filters {
            background-color: #000;
            border: 1px solid #80ff80;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .filter-group select, .filter-group input {
            width: 100%;
            padding: 8px;
            background-color: #2a2a2a;
            color: #80ff80;
            border: 1px solid #80ff80;
            font-family: 'Courier New', monospace;
        }
        .btn {
            background-color: #2a2a2a;
            color: #80ff80;
            border: 1px solid #80ff80;
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-right: 10px;
        }
        .btn:hover {
            background-color: #3a3a3a;
        }
        .summary {
            background-color: #003300;
            border: 1px solid #80ff80;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        .summary-item {
            flex: 1;
            min-width: 150px;
        }
        .summary-label {
            font-size: 12px;
            opacity: 0.8;
        }
        .summary-value {
            font-size: 24px;
            font-weight: bold;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #000;
        }
        th, td {
            border: 1px solid #80ff80;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #111;
            font-weight: bold;
        }
        tr:hover {
            background-color: #002200;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            opacity: 0.6;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #80ff80;
            text-decoration: none;
            border: 1px solid #80ff80;
            padding: 8px 16px;
        }
        .back-link:hover {
            background-color: #004400;
        }
        .cost-column {
            font-weight: bold;
            color: #00ff00;
        }
    </style>
</head>
<body onload="checkAccess(['Admin', 'Manager', 'Subcontractor', 'User']); initializePage();">

<a href="/static/AdminDashboard.html" class="back-link">‚Üê Back to Dashboard</a>

<h2>Equipment Usage Report</h2>

<div class="filters">
    <div class="filter-row">
        <div class="filter-group">
            <label>Start Date</label>
            <input type="date" id="startDate">
        </div>
        <div class="filter-group">
            <label>End Date</label>
            <input type="date" id="endDate">
        </div>
        <div class="filter-group">
            <label>Contractor</label>
            <select id="contractorFilter">
                <option value="">All Contractors</option>
            </select>
        </div>
    </div>
    <div class="filter-row">
        <div class="filter-group">
            <label>Property</label>
            <select id="propertyFilter">
                <option value="">All Properties</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Equipment</label>
            <select id="equipmentFilter">
                <option value="">All Equipment</option>
            </select>
        </div>
    </div>
    <button class="btn" onclick="generateReport()">Generate Report</button>
    <button class="btn" onclick="clearFilters()">Clear Filters</button>
    <button class="btn" onclick="exportToExcel()">Export to Excel</button>
</div>

<div class="summary" id="summary" style="display: none;">
    <div class="summary-item">
        <div class="summary-label">Total Equipment Types</div>
        <div class="summary-value" id="totalEquipment">0</div>
    </div>
    <div class="summary-item">
        <div class="summary-label">Total Uses</div>
        <div class="summary-value" id="totalUses">0</div>
    </div>
    <div class="summary-item">
        <div class="summary-label">Total Hours</div>
        <div class="summary-value" id="totalHours">0</div>
    </div>
    <div class="summary-item">
        <div class="summary-label">Total Cost</div>
        <div class="summary-value cost-column" id="totalCost">$0.00</div>
    </div>
</div>

<table>
    <thead>
        <tr>
            <th>Equipment Name</th>
            <th>Hourly Rate</th>
            <th>Total Uses</th>
            <th>Total Hours</th>
            <th>Total Cost</th>
        </tr>
    </thead>
    <tbody id="reportTableBody">
        <tr><td colspan="5" class="no-data">Select filters and click "Generate Report"</td></tr>
    </tbody>
</table>

<script>
let properties = [];
let contractors = [];
let equipmentList = [];
let showPricing = false; // Global flag for pricing visibility

async function initializePage() {
    // Check user role for pricing visibility
    const token = localStorage.getItem('token');
    if (token) {
        const payload = JSON.parse(atob(token.split('.')[1]));
        const userRole = payload.role;
        showPricing = (userRole === 'Admin' || userRole === 'Manager');

        // Hide pricing columns if user is not Admin/Manager
        if (!showPricing) {
            hidePricingColumns();
        }
    }

    await Promise.all([
        fetchProperties(),
        fetchContractors(),
        fetchEquipmentList()
    ]);
    populateFilters();

    // Set default date range (last 30 days)
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
}

function hidePricingColumns() {
    // Hide "Total Cost" summary item
    const summaryItems = document.querySelectorAll('.summary-item');
    summaryItems.forEach(item => {
        if (item.textContent.includes('Total Cost')) {
            item.style.display = 'none';
        }
    });

    // Hide "Hourly Rate" and "Total Cost" columns in table header
    const tableHeaders = document.querySelectorAll('th');
    tableHeaders.forEach((header, index) => {
        if (header.textContent === 'Hourly Rate' || header.textContent === 'Total Cost') {
            header.style.display = 'none';
        }
    });
}

async function fetchProperties() {
    const token = localStorage.getItem("token");
    try {
        const response = await fetch(`${API_BASE_URL}/properties/`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        properties = await response.json();
    } catch (err) {
        console.error("Error fetching properties:", err);
    }
}

async function fetchContractors() {
    const token = localStorage.getItem("token");
    try {
        const response = await fetch(`${API_BASE_URL}/contractors/`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        contractors = await response.json();
    } catch (err) {
        console.error("Error fetching contractors:", err);
    }
}

async function fetchEquipmentList() {
    try {
        const response = await fetch(`${API_BASE_URL}/equipment-rates/`);
        equipmentList = await response.json();
    } catch (err) {
        console.error("Error fetching equipment list:", err);
    }
}

function populateFilters() {
    // Populate property filter
    const propertySelect = document.getElementById('propertyFilter');
    properties.forEach(prop => {
        const option = document.createElement('option');
        option.value = prop.id;
        option.textContent = prop.name;
        propertySelect.appendChild(option);
    });

    // Populate contractor filter
    const contractorSelect = document.getElementById('contractorFilter');
    contractors.forEach(contractor => {
        const option = document.createElement('option');
        option.value = contractor.id;
        option.textContent = contractor.name;
        contractorSelect.appendChild(option);
    });

    // Populate equipment filter
    const equipmentSelect = document.getElementById('equipmentFilter');
    equipmentList.forEach(equipment => {
        const option = document.createElement('option');
        option.value = equipment.equipment_name;
        option.textContent = equipment.equipment_name;
        equipmentSelect.appendChild(option);
    });
}

async function generateReport() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const contractorId = document.getElementById('contractorFilter').value;
    const propertyId = document.getElementById('propertyFilter').value;
    const equipmentName = document.getElementById('equipmentFilter').value;

    // Build query parameters
    const params = new URLSearchParams();
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    if (contractorId) params.append('contractor_id', contractorId);
    if (propertyId) params.append('property_id', propertyId);
    if (equipmentName) params.append('equipment_name', equipmentName);

    const token = localStorage.getItem("token");
    try {
        const response = await fetch(`${API_BASE_URL}/equipment-usage-report/?${params.toString()}`, {
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (!response.ok) throw new Error(`Server error: ${response.status}`);

        const data = await response.json();
        renderReport(data);
    } catch (err) {
        console.error("Error generating report:", err);
        document.getElementById('reportTableBody').innerHTML =
            '<tr><td colspan="5" class="no-data">Failed to generate report. Check console.</td></tr>';
    }
}

function renderReport(data) {
    const tbody = document.getElementById('reportTableBody');

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="no-data">No equipment usage found for selected filters</td></tr>';
        document.getElementById('summary').style.display = 'none';
        return;
    }

    // Calculate totals
    let totalUses = 0;
    let totalHours = 0;
    let totalCost = 0;

    tbody.innerHTML = data.map(item => {
        const hours = parseFloat(item.total_hours || 0);
        const cost = parseFloat(item.total_cost || 0);
        const uses = parseInt(item.total_uses || 0);

        totalUses += uses;
        totalHours += hours;
        totalCost += cost;

        // Conditionally include pricing columns based on user role
        if (showPricing) {
            return `
                <tr>
                    <td>${item.equipment}</td>
                    <td>$${parseFloat(item.hourly_rate || 0).toFixed(2)}/hr</td>
                    <td>${uses}</td>
                    <td>${hours.toFixed(2)}</td>
                    <td class="cost-column">$${cost.toFixed(2)}</td>
                </tr>
            `;
        } else {
            return `
                <tr>
                    <td>${item.equipment}</td>
                    <td style="display: none;"></td>
                    <td>${uses}</td>
                    <td>${hours.toFixed(2)}</td>
                    <td style="display: none;"></td>
                </tr>
            `;
        }
    }).join('');

    // Update summary
    document.getElementById('summary').style.display = 'flex';
    document.getElementById('totalEquipment').textContent = data.length;
    document.getElementById('totalUses').textContent = totalUses;
    document.getElementById('totalHours').textContent = totalHours.toFixed(2);

    if (showPricing) {
        document.getElementById('totalCost').textContent = `$${totalCost.toFixed(2)}`;
    }
}

function clearFilters() {
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('contractorFilter').value = '';
    document.getElementById('propertyFilter').value = '';
    document.getElementById('equipmentFilter').value = '';

    document.getElementById('reportTableBody').innerHTML =
        '<tr><td colspan="5" class="no-data">Select filters and click "Generate Report"</td></tr>';
    document.getElementById('summary').style.display = 'none';
}

function exportToExcel() {
    alert('Export to Excel feature coming soon!');
}

function checkAccess(allowedRoles) {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/static/login.html';
        return;
    }
    const payload = JSON.parse(atob(token.split('.')[1]));
    const role = payload.role;
    if (!allowedRoles.includes(role)) {
        alert("Access denied.");
        window.location.href = '/static/login.html';
    }
}
</script>

  <script src="/static/ai-chat-widget.js"></script>
</body>
</html>
