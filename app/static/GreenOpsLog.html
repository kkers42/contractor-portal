<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green Operations Log</title>
    <script src="/static/config.js"></script>
    <link rel="stylesheet" href="/static/mobile-responsive.css">
    <link rel="stylesheet" href="/static/modern-theme.css">
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 0; padding: 20px;
            background-color: #1a1a1a;
            color: #80ff80;
        }
        .container {
            max-width: 600px; margin: auto;
            background-color: #000;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #80ff80;
            box-shadow: 0 0 10px rgba(0,255,0,0.2);
        }
        h2 {
            text-align: center;
            border-bottom: 1px solid #80ff80;
            padding-bottom: 10px;
        }
        label {
            display: block; margin-top: 10px;
        }
        input, select, textarea {
            width: 100%; padding: 8px;
            margin-top: 5px;
            border-radius: 4px;
            border: 1px solid #80ff80;
            background-color: #000;
            color: #80ff80;
            font-family: 'Courier New', monospace;
        }
        input::placeholder, textarea::placeholder {
            color: #80ff80;
            opacity: 0.6;
        }
        button {
            margin-top: 15px;
            width: 100%;
            padding: 10px;
            background-color: #000;
            color: #80ff80;
            border: 1px solid #80ff80;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 16px;
        }
        button:hover {
            background-color: #004400;
            border-color: #00cc00;
        }
    </style>
</head>
<body onload="checkAccess(['Admin', 'Manager', 'Subcontractor', 'User'])">
    <div class="container">
        <h2>Green Operations Log</h2>

        <label for="property">Property</label>
        <select id="property" required></select>

        <label for="subcontractor">Subcontractor Name</label>
        <input type="text" id="subcontractor" readonly>

        <label for="service">Service</label>
        <select id="service" required>
            <option value="Labor">Labor</option>
            <option value="Mowing">Mowing</option>
            <option value="Mowing and Trim">Mowing and Trim</option>
            <option value="Bulk install (Mulch, Topsoil, Aggregate)">Bulk install (Mulch, Topsoil, Aggregate)</option>
        </select>

        <label for="time_in">Time In</label>
        <input type="datetime-local" id="time_in" required>

        <label for="time_out">Time Out</label>
        <input type="datetime-local" id="time_out" required>

        <label for="bulk_salt_qty">Bulk Salt (Yards)</label>
        <input type="number" id="bulk_salt_qty" min="0" step="0.01" value="0">

        <label for="bag_salt_qty">Bag Salt (Bags)</label>
        <input type="number" id="bag_salt_qty" min="0" step="1" value="0">

        <label for="calcium_chloride_qty">Calcium Chloride (Bags)</label>
        <input type="number" id="calcium_chloride_qty" min="0" step="1" value="0">

        <label for="customer_provided">Customer Provided Product?</label>
        <select id="customer_provided">
            <option value="false">No</option>
            <option value="true">Yes</option>
        </select>

        <label for="notes">Notes</label>
        <textarea id="notes" rows="3" placeholder="Additional information..."></textarea>

        <button onclick="submitWinterOpsLog()">Submit Log</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetchProperties();
            populateSubcontractorName();
        });

        function populateSubcontractorName() {
            const token = localStorage.getItem('token');
            if (token) {
                const payload = JSON.parse(atob(token.split('.')[1]));
                document.getElementById('subcontractor').value = payload.name;
            }
        }

        async function fetchProperties() {
            try {
                const response = await fetch(`${API_BASE_URL}/properties/`);
                const properties = await response.json();
                const select = document.getElementById('property');

                properties.forEach(prop => {
                    const option = document.createElement('option');
                    option.value = prop.id;
                    option.textContent = `${prop.name} (${prop.address})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load properties:', error);
                alert('Could not load properties. Check console.');
            }
        }

        async function submitWinterOpsLog() {
            const data = {
                property_id: parseInt(document.getElementById('property').value),
                subcontractor_name: document.getElementById('subcontractor').value,
                service: document.getElementById('service').value,
                time_in: document.getElementById('time_in').value,
                time_out: document.getElementById('time_out').value,
                bulk_salt_qty: parseFloat(document.getElementById('bulk_salt_qty').value),
                bag_salt_qty: parseFloat(document.getElementById('bag_salt_qty').value),
                calcium_chloride_qty: parseFloat(document.getElementById('calcium_chloride_qty').value),
                customer_provided: document.getElementById('customer_provided').value === 'true',
                notes: document.getElementById('notes').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/submit-winter-log/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();
                alert(result.message || 'Green Ops Log submitted!');
                window.location.reload();
            } catch (error) {
                console.error('Error submitting log:', error);
                alert('Failed to submit log. Check console.');
            }
        }

        function checkAccess(allowedRoles) {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/static/login.html';
                return;
            }
            const payload = JSON.parse(atob(token.split('.')[1]));
            const role = payload.role;
            if (!allowedRoles.includes(role)) {
                alert("Access denied.");
                window.location.href = '/static/login.html';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/static/login.html';
        }
    </script>
</body>
</html>
