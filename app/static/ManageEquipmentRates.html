<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Equipment Rates</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <script src="/static/config.js"></script>
    <link rel="stylesheet" href="/static/mobile-responsive.css">
    <link rel="stylesheet" href="/static/modern-theme.css">
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #80ff80;
            padding: 20px;
        }
        h2 {
            text-align: center;
            border-bottom: 1px solid #80ff80;
            padding-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #000;
            color: #80ff80;
        }
        th, td {
            border: 1px solid #80ff80;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #111;
        }
        tr:nth-child(even) {
            background-color: #111;
        }
        button {
            margin: 5px;
            padding: 8px 16px;
            background-color: #000;
            color: #80ff80;
            border: 1px solid #80ff80;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }
        button:hover {
            background-color: #004400;
            border-color: #00cc00;
        }
        .delete-btn {
            background-color: #330000;
            border-color: #ff6666;
            color: #ff6666;
        }
        .delete-btn:hover {
            background-color: #660000;
            border-color: #ff3333;
        }
        .form-container {
            margin-top: 30px;
            background-color: #000;
            border: 1px solid #80ff80;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,255,0,0.2);
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0 10px;
            background-color: #000;
            color: #80ff80;
            border: 1px solid #80ff80;
            font-family: 'Courier New', monospace;
        }
        input::placeholder, textarea::placeholder {
            color: #80ff80;
            opacity: 0.6;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #80ff80;
            text-decoration: none;
            border: 1px solid #80ff80;
            padding: 8px 16px;
        }
        .back-link:hover {
            background-color: #004400;
        }
    </style>
</head>
<body onload="checkAccess(['Admin', 'Manager']); fetchEquipmentRates();">

<a href="/static/AdminDashboard.html" class="back-link">‚Üê Back to Dashboard</a>

<h2>Manage Equipment Rates</h2>

<table id="equipmentTable">
    <thead>
        <tr>
            <th>ID</th>
            <th>Equipment Name</th>
            <th>Hourly Rate ($)</th>
            <th>Description</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="form-container">
    <h3>Add / Update Equipment Rate</h3>
    <input type="hidden" id="equipment_id">
    <label>Equipment Name:</label>
    <input type="text" id="equipment_name" placeholder="e.g., Snowplow Truck, Skid Steer">
    <label>Hourly Rate ($):</label>
    <input type="number" id="hourly_rate" step="0.01" placeholder="e.g., 85.00">
    <label>Description (Optional):</label>
    <textarea id="description" rows="2" placeholder="Additional details about equipment..."></textarea>
    <button onclick="submitEquipment()">Submit Equipment Rate</button>
    <button onclick="clearForm()" style="background-color: #222;">Clear Form</button>
</div>

<script>
async function fetchEquipmentRates() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/equipment-rates/`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error(`Failed to fetch: ${response.status}`);

        const equipment = await response.json();
        const tableBody = document.querySelector('#equipmentTable tbody');
        tableBody.innerHTML = '';

        if (equipment.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; opacity: 0.6;">No equipment rates defined yet</td></tr>';
            return;
        }

        equipment.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.id}</td>
                <td>${item.equipment_name}</td>
                <td>$${parseFloat(item.hourly_rate).toFixed(2)}</td>
                <td>${item.description || 'N/A'}</td>
                <td>
                    <button onclick="editEquipment(${item.id}, '${item.equipment_name.replace(/'/g, "\\'")}', ${item.hourly_rate}, '${(item.description || '').replace(/'/g, "\\'")}')">Edit</button>
                    <button class="delete-btn" onclick="deleteEquipment(${item.id})" ${getCurrentUserRole() !== 'Admin' ? 'disabled' : ''}>Delete</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    } catch (error) {
        console.error('Error fetching equipment rates:', error);
        alert('Failed to load equipment rates. Check console.');
    }
}

function editEquipment(id, name, rate, description) {
    document.getElementById('equipment_id').value = id;
    document.getElementById('equipment_name').value = name;
    document.getElementById('hourly_rate').value = rate;
    document.getElementById('description').value = description;
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

async function submitEquipment() {
    const equipmentId = document.getElementById('equipment_id').value;
    const equipment = {
        equipment_name: document.getElementById('equipment_name').value,
        hourly_rate: parseFloat(document.getElementById('hourly_rate').value),
        description: document.getElementById('description').value || null
    };

    if (!equipment.equipment_name || !equipment.hourly_rate) {
        alert('Please fill in equipment name and hourly rate');
        return;
    }

    let url = `${API_BASE_URL}/equipment-rates/`;
    let method = 'POST';

    if (equipmentId) {
        url = `${API_BASE_URL}/equipment-rates/${equipmentId}`;
        method = 'PUT';
    }

    const token = localStorage.getItem('token');
    try {
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(equipment)
        });

        if (response.ok) {
            alert('Equipment rate saved successfully!');
            clearForm();
            fetchEquipmentRates();
        } else {
            const error = await response.json();
            alert(`Failed to save: ${error.detail || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error saving equipment rate:', error);
        alert('Failed to save equipment rate. Check console.');
    }
}

async function deleteEquipment(equipmentId) {
    if (!confirm('Are you sure you want to delete this equipment rate? This cannot be undone.')) return;

    const token = localStorage.getItem('token');
    try {
        const response = await fetch(`${API_BASE_URL}/equipment-rates/${equipmentId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            alert('Equipment rate deleted successfully!');
            fetchEquipmentRates();
        } else {
            const error = await response.json();
            alert(`Failed to delete: ${error.detail || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error deleting equipment rate:', error);
        alert('Failed to delete equipment rate. Check console.');
    }
}

function clearForm() {
    document.getElementById('equipment_id').value = '';
    document.getElementById('equipment_name').value = '';
    document.getElementById('hourly_rate').value = '';
    document.getElementById('description').value = '';
}

function getCurrentUserRole() {
    const token = localStorage.getItem('token');
    if (!token) return null;
    const payload = JSON.parse(atob(token.split('.')[1]));
    return payload.role;
}

function checkAccess(allowedRoles) {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/static/login.html';
        return;
    }
    const payload = JSON.parse(atob(token.split('.')[1]));
    const role = payload.role;
    if (!allowedRoles.includes(role)) {
        alert("Access denied. Managers and Admins only.");
        window.location.href = '/static/login.html';
    }
}
</script>

</body>
</html>
