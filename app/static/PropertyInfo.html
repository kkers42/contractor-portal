<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Property Information</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <script src="/static/config.js"></script>
  <link rel="stylesheet" href="/static/mobile-responsive.css">
    <link rel="stylesheet" href="/static/modern-theme.css">
  <style>
    body {
      font-family: 'Courier New', monospace;
      background-color: #1a1a1a;
      color: #80ff80;
      padding: 20px;
    }
    h2 {
      text-align: center;
      border-bottom: 1px solid #80ff80;
      padding-bottom: 10px;
    }
    .action-bar {
      margin: 20px 0;
      display: flex;
      gap: 10px;
      justify-content: flex-start;
    }
    .btn {
      background-color: #2a2a2a;
      color: #80ff80;
      border: 1px solid #80ff80;
      padding: 10px 20px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    .btn:hover {
      background-color: #3a3a3a;
    }
    .btn-danger {
      color: #ff8080;
      border-color: #ff8080;
    }
    .btn-danger:hover {
      background-color: #3a2a2a;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: #000;
    }
    th, td {
      border: 1px solid #80ff80;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #111;
    }
    .action-btns {
      display: flex;
      gap: 5px;
    }
    .action-btns button {
      padding: 5px 10px;
      font-size: 12px;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
    }
    .modal-content {
      background-color: #1a1a1a;
      margin: 5% auto;
      padding: 20px;
      border: 2px solid #80ff80;
      width: 80%;
      max-width: 600px;
      color: #80ff80;
    }
    .close {
      color: #ff8080;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: #ff4040;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      background-color: #2a2a2a;
      color: #80ff80;
      border: 1px solid #80ff80;
      font-family: 'Courier New', monospace;
    }
    .form-group input[type="checkbox"] {
      width: auto;
    }
    .checkbox-group {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    #bulkImportInput {
      display: none;
    }
    .filter-bar {
      margin: 20px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      padding: 15px;
      background-color: #0a0a0a;
      border: 1px solid #80ff80;
      border-radius: 4px;
    }
    .filter-select {
      background-color: #2a2a2a;
      color: #80ff80;
      border: 1px solid #80ff80;
      padding: 8px 12px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      border-radius: 4px;
      min-width: 180px;
    }
    .filter-select:focus {
      outline: none;
      border-color: #a0ffa0;
      background-color: #3a3a3a;
    }
  </style>
</head>
<body onload="initializePage()">
  <h2>All Properties</h2>

  <div class="action-bar">
    <button class="btn" onclick="location.href=getDashboardUrl()">üè† Back to Dashboard</button>
    <button class="btn" onclick="openAddModal()">+ Add Property</button>
    <button class="btn" onclick="document.getElementById('bulkImportInput').click()">Bulk Import (Excel)</button>
    <input type="file" id="bulkImportInput" accept=".xlsx,.xls" onchange="handleBulkImport(event)">
  </div>

  <div class="filter-bar">
    <select id="filterManager" class="filter-select" onchange="applyFilters()">
      <option value="">All Managers</option>
    </select>
    <select id="filterTrigger" class="filter-select" onchange="applyFilters()">
      <option value="">All Trigger Types</option>
      <option value="zero_tolerance">Zero Tolerance (0")</option>
      <option value="half_inch">0.5" Trigger</option>
      <option value="one_inch">1" Trigger</option>
      <option value="two_inch">2" Trigger</option>
      <option value="custom">Custom Trigger</option>
    </select>
    <select id="filterTier" class="filter-select" onchange="applyFilters()">
      <option value="">All Contract Tiers</option>
      <option value="Premium">Premium</option>
      <option value="Standard">Standard</option>
      <option value="Basic">Basic</option>
    </select>
    <select id="filterService" class="filter-select" onchange="applyFilters()">
      <option value="">All Services</option>
      <option value="plow">Plow Only</option>
      <option value="salt">Salt Only</option>
      <option value="both">Both Services</option>
    </select>
    <button class="btn" onclick="clearFilters()">Clear Filters</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Address</th>
        <th>Sq Ft</th>
        <th>Area Manager</th>
        <th>Plow</th>
        <th>Salt</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="propertyTableBody"></tbody>
  </table>

  <!-- Add/Edit Property Modal -->
  <div id="propertyModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3 id="modalTitle">Add Property</h3>
      <form id="propertyForm">
        <input type="hidden" id="propertyId">

        <div class="form-group">
          <label>Property Name:</label>
          <input type="text" id="propertyName" required>
        </div>

        <div class="form-group">
          <label>Address:</label>
          <input type="text" id="propertyAddress" required>
        </div>

        <div class="form-group">
          <label>Square Footage:</label>
          <input type="number" id="propertySqft" required>
        </div>

        <div class="form-group">
          <label>Area Manager:</label>
          <input type="text" id="propertyManager" required>
        </div>

        <div class="form-group checkbox-group">
          <label>
            <input type="checkbox" id="propertyPlow"> Plow Service
          </label>
          <label>
            <input type="checkbox" id="propertySalt"> Salt Service
          </label>
        </div>

        <div class="form-group">
          <label>Snow Trigger Type:</label>
          <select id="propertyTriggerType">
            <option value="zero_tolerance">Zero Tolerance (0")</option>
            <option value="half_inch">0.5" Trigger</option>
            <option value="one_inch">1" Trigger</option>
            <option value="two_inch" selected>2" Trigger</option>
            <option value="custom">Custom Amount</option>
          </select>
        </div>

        <div class="form-group" id="customTriggerGroup" style="display:none;">
          <label>Custom Trigger Amount (inches):</label>
          <input type="number" id="propertyTriggerAmount" step="0.25" min="0" max="12" value="2.0">
        </div>

        <div class="form-group">
          <label>Contract Tier:</label>
          <select id="propertyContractTier">
            <option value="Premium">Premium</option>
            <option value="Standard" selected>Standard</option>
            <option value="Basic">Basic</option>
          </select>
        </div>

        <div class="form-group">
          <label>Must Be Open By (Time):</label>
          <input type="time" id="propertyOpenByTime" placeholder="e.g., 06:00">
          <small style="opacity: 0.7;">Leave blank if no specific time requirement</small>
        </div>

        <div class="form-group">
          <label>Billing Type:</label>
          <select id="propertyBillingType" onchange="toggleBillingFields()">
            <option value="hourly">Hourly Rate (Current Setup)</option>
            <option value="per_occurrence">Per Occurrence</option>
          </select>
        </div>

        <div id="perOccurrenceRates" style="display: none; border: 1px solid #80ff80; padding: 15px; margin-top: 10px;">
          <h4 style="margin-top: 0; color: #80ff80;">Per Occurrence Rates</h4>

          <div class="form-group">
            <label>Plow Rate ($):</label>
            <input type="number" id="propertyPlowRate" step="0.01" min="0" placeholder="0.00">
          </div>

          <div class="form-group">
            <label>Salt Rate ($):</label>
            <input type="number" id="propertySaltRate" step="0.01" min="0" placeholder="0.00">
          </div>

          <div class="form-group">
            <label>Sidewalk De-Ice Rate ($):</label>
            <input type="number" id="propertySidewalkDeiceRate" step="0.01" min="0" placeholder="0.00">
          </div>

          <div class="form-group">
            <label>Sidewalk Snow Removal Rate ($):</label>
            <input type="number" id="propertySidewalkSnowRate" step="0.01" min="0" placeholder="0.00">
          </div>
        </div>

        <div class="form-group">
          <button type="submit" class="btn">Save Property</button>
          <button type="button" class="btn" onclick="closeModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let allProperties = []; // Store all properties for filtering

    async function initializePage() {
      checkAccess(['Admin', 'Manager', 'Subcontractor', 'User']);
      await fetchProperties();
    }

    async function fetchProperties() {
      const token = localStorage.getItem("token");
      try {
        const response = await fetch(`${API_BASE_URL}/properties/`, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });

        allProperties = await response.json();
        populateManagerFilter();
        renderProperties(allProperties);
      } catch (err) {
        console.error("Error fetching properties:", err);
        alert("Failed to load properties.");
      }
    }

    function populateManagerFilter() {
      const managers = [...new Set(allProperties.map(p => p.area_manager))].sort();
      const filterManager = document.getElementById('filterManager');

      // Clear existing options except "All Managers"
      filterManager.innerHTML = '<option value="">All Managers</option>';

      managers.forEach(manager => {
        const option = document.createElement('option');
        option.value = manager;
        option.textContent = manager;
        filterManager.appendChild(option);
      });
    }

    function renderProperties(properties) {
      const tbody = document.getElementById("propertyTableBody");
      tbody.innerHTML = "";

      properties.forEach(p => {
        const row = document.createElement("tr");
        // Store property data as JSON in data attribute for easy editing
        row.dataset.property = JSON.stringify(p);
        row.innerHTML = `
          <td>${p.name}</td>
          <td>${p.address}</td>
          <td>${p.sqft}</td>
          <td>${p.area_manager}</td>
          <td>${p.plow ? "Yes" : "No"}</td>
          <td>${p.salt ? "Yes" : "No"}</td>
          <td class="action-btns">
            <button class="btn" onclick="openEditModalFromRow(this)">Edit</button>
            <button class="btn btn-danger" onclick="deleteProperty(${p.id}, '${p.name.replace(/'/g, "\\'")}')">Delete</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function openEditModalFromRow(button) {
      const row = button.closest('tr');
      const property = JSON.parse(row.dataset.property);
      openEditModal(property);
    }

    function applyFilters() {
      const filterManager = document.getElementById('filterManager').value;
      const filterTrigger = document.getElementById('filterTrigger').value;
      const filterTier = document.getElementById('filterTier').value;
      const filterService = document.getElementById('filterService').value;

      let filtered = allProperties;

      // Filter by manager
      if (filterManager) {
        filtered = filtered.filter(p => p.area_manager === filterManager);
      }

      // Filter by trigger type
      if (filterTrigger) {
        filtered = filtered.filter(p => p.trigger_type === filterTrigger);
      }

      // Filter by contract tier
      if (filterTier) {
        filtered = filtered.filter(p => p.contract_tier === filterTier);
      }

      // Filter by service type
      if (filterService === 'plow') {
        filtered = filtered.filter(p => p.plow && !p.salt);
      } else if (filterService === 'salt') {
        filtered = filtered.filter(p => p.salt && !p.plow);
      } else if (filterService === 'both') {
        filtered = filtered.filter(p => p.plow && p.salt);
      }

      renderProperties(filtered);
    }

    function clearFilters() {
      document.getElementById('filterManager').value = '';
      document.getElementById('filterTrigger').value = '';
      document.getElementById('filterTier').value = '';
      document.getElementById('filterService').value = '';
      renderProperties(allProperties);
    }

    function openAddModal() {
      document.getElementById('modalTitle').textContent = 'Add Property';
      document.getElementById('propertyForm').reset();
      document.getElementById('propertyId').value = '';
      toggleBillingFields(); // Initialize billing fields visibility
      document.getElementById('propertyModal').style.display = 'block';
    }

    function openEditModal(property) {
      document.getElementById('modalTitle').textContent = 'Edit Property';
      document.getElementById('propertyId').value = property.id;
      document.getElementById('propertyName').value = property.name;
      document.getElementById('propertyAddress').value = property.address;
      document.getElementById('propertySqft').value = property.sqft;
      document.getElementById('propertyManager').value = property.area_manager;
      document.getElementById('propertyPlow').checked = property.plow;
      document.getElementById('propertySalt').checked = property.salt;
      document.getElementById('propertyTriggerType').value = property.trigger_type || 'two_inch';
      document.getElementById('propertyTriggerAmount').value = property.trigger_amount || 2.0;
      document.getElementById('propertyContractTier').value = property.contract_tier || 'Standard';
      document.getElementById('propertyOpenByTime').value = property.open_by_time || '';

      // Show/hide custom trigger amount field based on trigger type
      const customGroup = document.getElementById('customTriggerGroup');
      if (property.trigger_type === 'custom') {
        customGroup.style.display = 'block';
      } else {
        customGroup.style.display = 'none';
      }

      // Populate billing type fields
      document.getElementById('propertyBillingType').value = property.billing_type || 'hourly';
      document.getElementById('propertyPlowRate').value = property.plow_rate || '';
      document.getElementById('propertySaltRate').value = property.salt_rate || '';
      document.getElementById('propertySidewalkDeiceRate').value = property.sidewalk_deice_rate || '';
      document.getElementById('propertySidewalkSnowRate').value = property.sidewalk_snow_rate || '';
      toggleBillingFields(); // Show/hide per occurrence fields based on billing type

      document.getElementById('propertyModal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('propertyModal').style.display = 'none';
    }

    // Toggle billing fields based on billing type
    function toggleBillingFields() {
      const billingType = document.getElementById('propertyBillingType').value;
      const perOccurrenceRates = document.getElementById('perOccurrenceRates');

      if (billingType === 'per_occurrence') {
        perOccurrenceRates.style.display = 'block';
      } else {
        perOccurrenceRates.style.display = 'none';
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('propertyModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    // Handle form submission
    document.getElementById('propertyForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const propertyId = document.getElementById('propertyId').value;
      const triggerType = document.getElementById('propertyTriggerType').value;
      let triggerAmount = 2.0; // default

      // Calculate trigger amount based on type
      if (triggerType === 'zero_tolerance') triggerAmount = 0.0;
      else if (triggerType === 'half_inch') triggerAmount = 0.5;
      else if (triggerType === 'one_inch') triggerAmount = 1.0;
      else if (triggerType === 'two_inch') triggerAmount = 2.0;
      else if (triggerType === 'custom') triggerAmount = parseFloat(document.getElementById('propertyTriggerAmount').value);

      const billingType = document.getElementById('propertyBillingType').value;

      const propertyData = {
        name: document.getElementById('propertyName').value,
        address: document.getElementById('propertyAddress').value,
        sqft: parseInt(document.getElementById('propertySqft').value),
        area_manager: document.getElementById('propertyManager').value,
        plow: document.getElementById('propertyPlow').checked,
        salt: document.getElementById('propertySalt').checked,
        trigger_type: triggerType,
        trigger_amount: triggerAmount,
        contract_tier: document.getElementById('propertyContractTier').value,
        open_by_time: document.getElementById('propertyOpenByTime').value || null,
        billing_type: billingType
      };

      // Add per-occurrence rates if that billing type is selected
      if (billingType === 'per_occurrence') {
        const plowRate = document.getElementById('propertyPlowRate').value;
        const saltRate = document.getElementById('propertySaltRate').value;
        const sidewalkDeiceRate = document.getElementById('propertySidewalkDeiceRate').value;
        const sidewalkSnowRate = document.getElementById('propertySidewalkSnowRate').value;

        if (plowRate) propertyData.plow_rate = parseFloat(plowRate);
        if (saltRate) propertyData.salt_rate = parseFloat(saltRate);
        if (sidewalkDeiceRate) propertyData.sidewalk_deice_rate = parseFloat(sidewalkDeiceRate);
        if (sidewalkSnowRate) propertyData.sidewalk_snow_rate = parseFloat(sidewalkSnowRate);
      }

      const token = localStorage.getItem("token");

      try {
        let response;
        if (propertyId) {
          // Update existing property
          response = await fetch(`${API_BASE_URL}/update-property/`, {
            method: "PUT",
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ ...propertyData, id: parseInt(propertyId) })
          });
        } else {
          // Add new property
          response = await fetch(`${API_BASE_URL}/add-property/`, {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify(propertyData)
          });
        }

        const result = await response.json();

        if (response.ok) {
          alert(result.message || 'Property saved successfully!');
          closeModal();
          await fetchProperties();
        } else {
          alert('Error: ' + (result.detail || 'Failed to save property'));
        }
      } catch (err) {
        console.error('Error saving property:', err);
        alert('Failed to save property. Please try again.');
      }
    });

    async function deleteProperty(id, name) {
      if (!confirm(`Are you sure you want to delete "${name}"?`)) {
        return;
      }

      const token = localStorage.getItem("token");

      try {
        const response = await fetch(`${API_BASE_URL}/delete-property/${id}`, {
          method: "DELETE",
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });

        const result = await response.json();

        if (response.ok) {
          alert(result.message || 'Property deleted successfully!');
          await fetchProperties();
        } else {
          alert('Error: ' + (result.detail || 'Failed to delete property'));
        }
      } catch (err) {
        console.error('Error deleting property:', err);
        alert('Failed to delete property. Please try again.');
      }
    }

    async function handleBulkImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('file', file);

      const token = localStorage.getItem("token");

      try {
        const response = await fetch(`${API_BASE_URL}/bulk-import-properties/`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`
          },
          body: formData
        });

        const result = await response.json();

        if (response.ok) {
          alert(result.message || `Successfully imported ${result.count || 0} properties!`);
          await fetchProperties();
        } else {
          alert('Error: ' + (result.detail || 'Failed to import properties'));
        }
      } catch (err) {
        console.error('Error importing properties:', err);
        alert('Failed to import properties. Please try again.');
      }

      // Reset file input
      event.target.value = '';
    }

    // Show/hide custom trigger amount field
    document.getElementById('propertyTriggerType').addEventListener('change', function() {
      const customGroup = document.getElementById('customTriggerGroup');
      if (this.value === 'custom') {
        customGroup.style.display = 'block';
      } else {
        customGroup.style.display = 'none';
      }
    });
  </script>
    <script src="/static/ai-chat-widget.js"></script>
</body>
</html>
