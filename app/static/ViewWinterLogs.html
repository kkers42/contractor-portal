<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>View Winter Operations Logs</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <script src="/static/config.js"></script>
  <link rel="stylesheet" href="/static/mobile-responsive.css">
    <link rel="stylesheet" href="/static/modern-theme.css">
  <style>
    body {
      font-family: 'Courier New', monospace;
      background-color: #1a1a1a;
      color: #80ff80;
      padding: 20px;
    }
    h2 {
      text-align: center;
      border-bottom: 1px solid #80ff80;
      padding-bottom: 10px;
    }
    .filters {
      background-color: #000;
      border: 1px solid #80ff80;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 5px;
    }
    .filter-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    .filter-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .filter-group select, .filter-group input {
      width: 100%;
      padding: 8px;
      background-color: #2a2a2a;
      color: #80ff80;
      border: 1px solid #80ff80;
      font-family: 'Courier New', monospace;
    }
    .btn {
      background-color: #2a2a2a;
      color: #80ff80;
      border: 1px solid #80ff80;
      padding: 10px 20px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      margin-right: 10px;
    }
    .btn:hover {
      background-color: #3a3a3a;
    }
    .summary {
      background-color: #003300;
      border: 1px solid #80ff80;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }
    .summary-item {
      flex: 1;
      min-width: 150px;
    }
    .summary-label {
      font-size: 12px;
      opacity: 0.8;
    }
    .summary-value {
      font-size: 24px;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #000;
    }
    th, td {
      border: 1px solid #80ff80;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #111;
      font-weight: bold;
    }
    tr:hover {
      background-color: #002200;
    }
    .no-data {
      text-align: center;
      padding: 40px;
      font-size: 18px;
      opacity: 0.6;
    }
    .action-btn {
      padding: 5px 10px;
      margin: 2px;
      font-size: 12px;
      cursor: pointer;
      background-color: #2a2a2a;
      color: #80ff80;
      border: 1px solid #80ff80;
      font-family: 'Courier New', monospace;
    }
    .action-btn:hover {
      background-color: #004400;
    }
    .delete-btn {
      background-color: #330000;
      border-color: #ff6666;
      color: #ff6666;
    }
    .delete-btn:hover {
      background-color: #660000;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      overflow-y: auto;
    }
    .modal-content {
      background-color: #1a1a1a;
      margin: 50px auto;
      padding: 30px;
      border: 2px solid #80ff80;
      width: 90%;
      max-width: 800px;
      border-radius: 10px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid #80ff80;
      padding-bottom: 10px;
    }
    .close {
      color: #ff6666;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: #ff3333;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px;
      background-color: #2a2a2a;
      color: #80ff80;
      border: 1px solid #80ff80;
      font-family: 'Courier New', monospace;
      box-sizing: border-box;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
  </style>
</head>
<body onload="initializePage()">
  <h2>Winter Operations Logs</h2>

  <div class="filters">
    <div class="filter-row">
      <div class="filter-group">
        <label>Property</label>
        <select id="propertyFilter">
          <option value="">All Properties</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Contractor</label>
        <select id="contractorFilter">
          <option value="">All Contractors</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Start Date</label>
        <input type="date" id="startDate">
      </div>
      <div class="filter-group">
        <label>End Date</label>
        <input type="date" id="endDate">
      </div>
    </div>
    <button class="btn" onclick="applyFilters()">Apply Filters</button>
    <button class="btn" onclick="clearFilters()">Clear Filters</button>
    <button class="btn" onclick="exportToExcel()">Export to Excel</button>
  </div>

  <div class="summary" id="summary" style="display: none;">
    <div class="summary-item">
      <div class="summary-label">Total Logs</div>
      <div class="summary-value" id="totalLogs">0</div>
    </div>
    <div class="summary-item">
      <div class="summary-label">Total Hours</div>
      <div class="summary-value" id="totalHours">0</div>
    </div>
    <div class="summary-item">
      <div class="summary-label">Bulk Salt (tons)</div>
      <div class="summary-value" id="totalBulkSalt">0</div>
    </div>
    <div class="summary-item">
      <div class="summary-label">Bag Salt</div>
      <div class="summary-value" id="totalBagSalt">0</div>
    </div>
    <div class="summary-item">
      <div class="summary-label">Calcium Chloride</div>
      <div class="summary-value" id="totalCalcium">0</div>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Property</th>
        <th>Contractor</th>
        <th>Worker</th>
        <th>Equipment</th>
        <th>Time In</th>
        <th>Time Out</th>
        <th>Hours</th>
        <th>Bulk Salt</th>
        <th>Bag Salt</th>
        <th>Calcium</th>
        <th>Customer Provided</th>
        <th>Notes</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="logsTableBody">
      <tr><td colspan="14" class="no-data">Loading logs...</td></tr>
    </tbody>
  </table>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Winter Operations Log</h3>
        <span class="close" onclick="closeEditModal()">&times;</span>
      </div>
      <form id="editForm" onsubmit="submitEdit(event)">
        <input type="hidden" id="edit_log_id">

        <div class="form-group">
          <label>Property *</label>
          <select id="edit_property_id" required>
            <option value="">Select Property</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Contractor Name</label>
            <input type="text" id="edit_contractor_name">
          </div>
          <div class="form-group">
            <label>Worker Name</label>
            <input type="text" id="edit_worker_name">
          </div>
        </div>

        <div class="form-group">
          <label>Equipment</label>
          <input type="text" id="edit_equipment">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Time In *</label>
            <input type="datetime-local" id="edit_time_in" required>
          </div>
          <div class="form-group">
            <label>Time Out *</label>
            <input type="datetime-local" id="edit_time_out" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Bulk Salt (tons)</label>
            <input type="number" step="0.01" id="edit_bulk_salt_qty" value="0">
          </div>
          <div class="form-group">
            <label>Bag Salt (bags)</label>
            <input type="number" step="0.01" id="edit_bag_salt_qty" value="0">
          </div>
        </div>

        <div class="form-group">
          <label>Calcium Chloride (lbs)</label>
          <input type="number" step="0.01" id="edit_calcium_chloride_qty" value="0">
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="edit_customer_provided" style="width: auto; margin-right: 5px;">
            Customer Provided Materials
          </label>
        </div>

        <div class="form-group">
          <label>Notes</label>
          <textarea id="edit_notes" rows="4"></textarea>
        </div>

        <div style="text-align: right; margin-top: 20px;">
          <button type="button" class="btn" onclick="closeEditModal()" style="background-color: #660000; border-color: #ff6666; color: #ff6666;">Cancel</button>
          <button type="submit" class="btn">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let allLogs = [];
    let properties = [];
    let contractors = new Set();

    async function initializePage() {
      checkAccess(['Admin', 'Manager', 'Subcontractor']);
      await Promise.all([fetchProperties(), fetchLogs()]);
      populateFilters();
    }

    async function fetchProperties() {
      const token = localStorage.getItem("token");
      try {
        const response = await fetch(`${API_BASE_URL}/properties/`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        properties = await response.json();
      } catch (err) {
        console.error("Error fetching properties:", err);
      }
    }

    async function fetchLogs() {
      const token = localStorage.getItem("token");
      try {
        const response = await fetch(`${API_BASE_URL}/winter-logs/`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        allLogs = await response.json();

        // Extract unique contractors
        contractors = new Set(allLogs.map(log => log.contractor_name).filter(Boolean));

        renderLogs(allLogs);
      } catch (err) {
        console.error("Error fetching logs:", err);
        document.getElementById('logsTableBody').innerHTML =
          '<tr><td colspan="14" class="no-data">Failed to load logs</td></tr>';
      }
    }

    function populateFilters() {
      // Populate property filter
      const propertySelect = document.getElementById('propertyFilter');
      properties.forEach(prop => {
        const option = document.createElement('option');
        option.value = prop.name;
        option.textContent = prop.name;
        propertySelect.appendChild(option);
      });

      // Populate contractor filter
      const contractorSelect = document.getElementById('contractorFilter');
      contractors.forEach(contractor => {
        const option = document.createElement('option');
        option.value = contractor;
        option.textContent = contractor;
        contractorSelect.appendChild(option);
      });
    }

    function applyFilters() {
      const propertyFilter = document.getElementById('propertyFilter').value;
      const contractorFilter = document.getElementById('contractorFilter').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      let filtered = allLogs.filter(log => {
        if (propertyFilter && log.property_name !== propertyFilter) return false;
        if (contractorFilter && log.contractor_name !== contractorFilter) return false;

        if (startDate) {
          const logDate = new Date(log.time_in).toISOString().split('T')[0];
          if (logDate < startDate) return false;
        }

        if (endDate) {
          const logDate = new Date(log.time_in).toISOString().split('T')[0];
          if (logDate > endDate) return false;
        }

        return true;
      });

      renderLogs(filtered);
    }

    function clearFilters() {
      document.getElementById('propertyFilter').value = '';
      document.getElementById('contractorFilter').value = '';
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      renderLogs(allLogs);
    }

    function renderLogs(logs) {
      const tbody = document.getElementById('logsTableBody');

      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="14" class="no-data">No logs found</td></tr>';
        document.getElementById('summary').style.display = 'none';
        return;
      }

      // Calculate totals
      let totalHours = 0;
      let totalBulkSalt = 0;
      let totalBagSalt = 0;
      let totalCalcium = 0;

      tbody.innerHTML = logs.map(log => {
        const timeIn = new Date(log.time_in);
        const timeOut = new Date(log.time_out);
        const hours = ((timeOut - timeIn) / 1000 / 3600).toFixed(2);

        totalHours += parseFloat(hours);
        totalBulkSalt += parseFloat(log.bulk_salt_qty || 0);
        totalBagSalt += parseFloat(log.bag_salt_qty || 0);
        totalCalcium += parseFloat(log.calcium_chloride_qty || 0);

        const userRole = getCurrentUserRole();
        const canEdit = userRole === 'Admin' || userRole === 'Manager';
        const canDelete = userRole === 'Admin';

        return `
          <tr>
            <td>${timeIn.toLocaleDateString()}</td>
            <td>${log.property_name}</td>
            <td>${log.contractor_name || 'N/A'}</td>
            <td>${log.worker_name || 'N/A'}</td>
            <td>${log.equipment || 'N/A'}</td>
            <td>${timeIn.toLocaleTimeString()}</td>
            <td>${timeOut.toLocaleTimeString()}</td>
            <td>${hours}</td>
            <td>${log.bulk_salt_qty || 0}</td>
            <td>${log.bag_salt_qty || 0}</td>
            <td>${log.calcium_chloride_qty || 0}</td>
            <td>${log.customer_provided ? 'Yes' : 'No'}</td>
            <td>${log.notes || ''}</td>
            <td>
              ${canEdit ? `<button class="action-btn" onclick="editLog(${log.id})">Edit</button>` : ''}
              ${canDelete ? `<button class="action-btn delete-btn" onclick="deleteLog(${log.id})">Delete</button>` : ''}
              ${!canEdit && !canDelete ? 'N/A' : ''}
            </td>
          </tr>
        `;
      }).join('');

      // Update summary
      document.getElementById('summary').style.display = 'flex';
      document.getElementById('totalLogs').textContent = logs.length;
      document.getElementById('totalHours').textContent = totalHours.toFixed(2);
      document.getElementById('totalBulkSalt').textContent = totalBulkSalt.toFixed(2);
      document.getElementById('totalBagSalt').textContent = totalBagSalt;
      document.getElementById('totalCalcium').textContent = totalCalcium;
    }

    function exportToExcel() {
      alert('Export to Excel feature coming soon!');
    }

    function getCurrentUserRole() {
      const token = localStorage.getItem('token');
      if (!token) return null;
      const payload = JSON.parse(atob(token.split('.')[1]));
      return payload.role;
    }

    function editLog(logId) {
      const log = allLogs.find(l => l.id === logId);
      if (!log) {
        alert('Log not found');
        return;
      }

      // Populate the property dropdown in edit modal
      const propertySelect = document.getElementById('edit_property_id');
      propertySelect.innerHTML = '<option value="">Select Property</option>';
      properties.forEach(prop => {
        const option = document.createElement('option');
        option.value = prop.id;
        option.textContent = prop.name;
        if (prop.id === log.property_id) {
          option.selected = true;
        }
        propertySelect.appendChild(option);
      });

      // Populate form fields
      document.getElementById('edit_log_id').value = log.id;
      document.getElementById('edit_property_id').value = log.property_id || '';
      document.getElementById('edit_contractor_name').value = log.contractor_name || '';
      document.getElementById('edit_worker_name').value = log.worker_name || '';
      document.getElementById('edit_equipment').value = log.equipment || '';

      // Format datetime for input (convert to local timezone)
      if (log.time_in) {
        const timeIn = new Date(log.time_in);
        document.getElementById('edit_time_in').value = formatDateTimeLocal(timeIn);
      }
      if (log.time_out) {
        const timeOut = new Date(log.time_out);
        document.getElementById('edit_time_out').value = formatDateTimeLocal(timeOut);
      }

      document.getElementById('edit_bulk_salt_qty').value = log.bulk_salt_qty || 0;
      document.getElementById('edit_bag_salt_qty').value = log.bag_salt_qty || 0;
      document.getElementById('edit_calcium_chloride_qty').value = log.calcium_chloride_qty || 0;
      document.getElementById('edit_customer_provided').checked = log.customer_provided || false;
      document.getElementById('edit_notes').value = log.notes || '';

      // Show modal
      document.getElementById('editModal').style.display = 'block';
    }

    function formatDateTimeLocal(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    async function submitEdit(event) {
      event.preventDefault();

      const logId = document.getElementById('edit_log_id').value;
      const token = localStorage.getItem('token');

      const logData = {
        property_id: parseInt(document.getElementById('edit_property_id').value),
        contractor_id: null, // Backend will handle this
        contractor_name: document.getElementById('edit_contractor_name').value,
        worker_name: document.getElementById('edit_worker_name').value,
        equipment: document.getElementById('edit_equipment').value,
        time_in: document.getElementById('edit_time_in').value,
        time_out: document.getElementById('edit_time_out').value,
        bulk_salt_qty: parseFloat(document.getElementById('edit_bulk_salt_qty').value) || 0,
        bag_salt_qty: parseFloat(document.getElementById('edit_bag_salt_qty').value) || 0,
        calcium_chloride_qty: parseFloat(document.getElementById('edit_calcium_chloride_qty').value) || 0,
        customer_provided: document.getElementById('edit_customer_provided').checked,
        notes: document.getElementById('edit_notes').value
      };

      try {
        const response = await fetch(`${API_BASE_URL}/winter-logs/${logId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(logData)
        });

        if (response.ok) {
          alert('Log updated successfully!');
          closeEditModal();
          await fetchLogs(); // Reload logs
        } else {
          const error = await response.json();
          alert(`Failed to update log: ${error.detail || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Error updating log:', error);
        alert('Failed to update log. Please try again.');
      }
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
      const modal = document.getElementById('editModal');
      if (event.target == modal) {
        closeEditModal();
      }
    }

    async function deleteLog(logId) {
      if (!confirm('Are you sure you want to delete this log? This cannot be undone.')) return;

      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE_URL}/winter-logs/${logId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          alert('Log deleted successfully!');
          await fetchLogs();
        } else {
          const error = await response.json();
          alert(`Failed to delete log: ${error.detail || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Error deleting log:', error);
        alert('Failed to delete log. Check console.');
      }
    }

    function checkAccess(allowedRoles) {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/static/login.html';
        return;
      }
      const payload = JSON.parse(atob(token.split('.')[1]));
      const role = payload.role;
      if (!allowedRoles.includes(role)) {
        alert("Access denied.");
        window.location.href = '/static/login.html';
      }
    }
  </script>
</body>
</html>
