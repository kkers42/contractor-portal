<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>View Lawn/Landscape Logs</title>
  <script src="/static/config.js"></script>
  <link rel="stylesheet" href="/static/mobile-responsive.css">
    <link rel="stylesheet" href="/static/modern-theme.css">
  <style>
    body {
      font-family: 'Courier New', monospace;
      background-color: #1a1a1a;
      color: #80ff80;
      padding: 20px;
    }
    h2 {
      text-align: center;
      border-bottom: 1px solid #80ff80;
      padding-bottom: 10px;
    }
    .filters {
      background-color: #000;
      border: 1px solid #80ff80;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 5px;
    }
    .filter-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    .filter-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .filter-group select, .filter-group input {
      width: 100%;
      padding: 8px;
      background-color: #2a2a2a;
      color: #80ff80;
      border: 1px solid #80ff80;
      font-family: 'Courier New', monospace;
    }
    .btn {
      background-color: #2a2a2a;
      color: #80ff80;
      border: 1px solid #80ff80;
      padding: 10px 20px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      margin-right: 10px;
    }
    .btn:hover {
      background-color: #3a3a3a;
    }
    .summary {
      background-color: #003300;
      border: 1px solid #80ff80;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }
    .summary-item {
      flex: 1;
      min-width: 150px;
    }
    .summary-label {
      font-size: 12px;
      opacity: 0.8;
    }
    .summary-value {
      font-size: 24px;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #000;
    }
    th, td {
      border: 1px solid #80ff80;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #111;
      font-weight: bold;
    }
    tr:hover {
      background-color: #002200;
    }
    .no-data {
      text-align: center;
      padding: 40px;
      font-size: 18px;
      opacity: 0.6;
    }
    .action-btn {
      padding: 5px 10px;
      margin: 2px;
      font-size: 12px;
      cursor: pointer;
      background-color: #2a2a2a;
      color: #80ff80;
      border: 1px solid #80ff80;
      font-family: 'Courier New', monospace;
    }
    .action-btn:hover {
      background-color: #004400;
    }
    .delete-btn {
      background-color: #330000;
      border-color: #ff6666;
      color: #ff6666;
    }
    .delete-btn:hover {
      background-color: #660000;
    }
  </style>
</head>
<body onload="initializePage()">
  <h2>Lawn & Landscape Service Logs</h2>

  <div class="filters">
    <div class="filter-row">
      <div class="filter-group">
        <label>Property</label>
        <select id="propertyFilter">
          <option value="">All Properties</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Contractor</label>
        <select id="contractorFilter">
          <option value="">All Contractors</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Service Type</label>
        <select id="serviceFilter">
          <option value="">All Services</option>
        </select>
      </div>
    </div>
    <div class="filter-row">
      <div class="filter-group">
        <label>Start Date</label>
        <input type="date" id="startDate">
      </div>
      <div class="filter-group">
        <label>End Date</label>
        <input type="date" id="endDate">
      </div>
    </div>
    <button class="btn" onclick="applyFilters()">Apply Filters</button>
    <button class="btn" onclick="clearFilters()">Clear Filters</button>
    <button class="btn" onclick="exportToExcel()">Export to Excel</button>
  </div>

  <div class="summary" id="summary" style="display: none;">
    <div class="summary-item">
      <div class="summary-label">Total Logs</div>
      <div class="summary-value" id="totalLogs">0</div>
    </div>
    <div class="summary-item">
      <div class="summary-label">Total Hours</div>
      <div class="summary-value" id="totalHours">0</div>
    </div>
    <div class="summary-item">
      <div class="summary-label">Products Used</div>
      <div class="summary-value" id="totalProducts">0</div>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Property</th>
        <th>Contractor</th>
        <th>Worker</th>
        <th>Service Type</th>
        <th>Time In</th>
        <th>Time Out</th>
        <th>Hours</th>
        <th>Products Used</th>
        <th>Quantity</th>
        <th>Notes</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="logsTableBody">
      <tr><td colspan="12" class="no-data">Loading logs...</td></tr>
    </tbody>
  </table>

  <script>
    let allLogs = [];
    let properties = [];
    let contractors = new Set();
    let serviceTypes = new Set();

    async function initializePage() {
      checkAccess(['Admin', 'Manager', 'Subcontractor', 'User']);
      await Promise.all([fetchProperties(), fetchLogs()]);
      populateFilters();
    }

    async function fetchProperties() {
      const token = localStorage.getItem("token");
      try {
        const response = await fetch(`${API_BASE_URL}/properties/`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        properties = await response.json();
      } catch (err) {
        console.error("Error fetching properties:", err);
      }
    }

    async function fetchLogs() {
      const token = localStorage.getItem("token");
      try {
        const response = await fetch(`${API_BASE_URL}/green-logs/`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        allLogs = await response.json();

        // Extract unique contractors and service types
        contractors = new Set(allLogs.map(log => log.contractor_name).filter(Boolean));
        serviceTypes = new Set(allLogs.map(log => log.service_type));

        renderLogs(allLogs);
      } catch (err) {
        console.error("Error fetching logs:", err);
        document.getElementById('logsTableBody').innerHTML =
          '<tr><td colspan="12" class="no-data">Failed to load logs</td></tr>';
      }
    }

    function populateFilters() {
      // Populate property filter
      const propertySelect = document.getElementById('propertyFilter');
      properties.forEach(prop => {
        const option = document.createElement('option');
        option.value = prop.name;
        option.textContent = prop.name;
        propertySelect.appendChild(option);
      });

      // Populate contractor filter
      const contractorSelect = document.getElementById('contractorFilter');
      contractors.forEach(contractor => {
        const option = document.createElement('option');
        option.value = contractor;
        option.textContent = contractor;
        contractorSelect.appendChild(option);
      });

      // Populate service type filter
      const serviceSelect = document.getElementById('serviceFilter');
      serviceTypes.forEach(service => {
        const option = document.createElement('option');
        option.value = service;
        option.textContent = service;
        serviceSelect.appendChild(option);
      });
    }

    function applyFilters() {
      const propertyFilter = document.getElementById('propertyFilter').value;
      const contractorFilter = document.getElementById('contractorFilter').value;
      const serviceFilter = document.getElementById('serviceFilter').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      let filtered = allLogs.filter(log => {
        if (propertyFilter && log.property_name !== propertyFilter) return false;
        if (contractorFilter && log.contractor_name !== contractorFilter) return false;
        if (serviceFilter && log.service_type !== serviceFilter) return false;

        if (startDate) {
          const logDate = new Date(log.time_in).toISOString().split('T')[0];
          if (logDate < startDate) return false;
        }

        if (endDate) {
          const logDate = new Date(log.time_in).toISOString().split('T')[0];
          if (logDate > endDate) return false;
        }

        return true;
      });

      renderLogs(filtered);
    }

    function clearFilters() {
      document.getElementById('propertyFilter').value = '';
      document.getElementById('contractorFilter').value = '';
      document.getElementById('serviceFilter').value = '';
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      renderLogs(allLogs);
    }

    function renderLogs(logs) {
      const tbody = document.getElementById('logsTableBody');

      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" class="no-data">No logs found</td></tr>';
        document.getElementById('summary').style.display = 'none';
        return;
      }

      // Calculate totals
      let totalHours = 0;
      let totalProducts = 0;

      tbody.innerHTML = logs.map(log => {
        const timeIn = new Date(log.time_in);
        const timeOut = new Date(log.time_out);
        const hours = ((timeOut - timeIn) / 1000 / 3600).toFixed(2);

        totalHours += parseFloat(hours);
        totalProducts += parseFloat(log.quantity_used || 0);

        const userRole = getCurrentUserRole();
        const canEdit = userRole === 'Admin' || userRole === 'Manager';
        const canDelete = userRole === 'Admin';

        return `
          <tr>
            <td>${timeIn.toLocaleDateString()}</td>
            <td>${log.property_name}</td>
            <td>${log.contractor_name || 'N/A'}</td>
            <td>${log.worker_name || 'N/A'}</td>
            <td>${log.service_type}</td>
            <td>${timeIn.toLocaleTimeString()}</td>
            <td>${timeOut.toLocaleTimeString()}</td>
            <td>${hours}</td>
            <td>${log.products_used || 'N/A'}</td>
            <td>${log.quantity_used || 0}</td>
            <td>${log.notes || ''}</td>
            <td>
              ${canEdit ? `<button class="action-btn" onclick="editLog(${log.id})">Edit</button>` : ''}
              ${canDelete ? `<button class="action-btn delete-btn" onclick="deleteLog(${log.id})">Delete</button>` : ''}
              ${!canEdit && !canDelete ? 'N/A' : ''}
            </td>
          </tr>
        `;
      }).join('');

      // Update summary
      document.getElementById('summary').style.display = 'flex';
      document.getElementById('totalLogs').textContent = logs.length;
      document.getElementById('totalHours').textContent = totalHours.toFixed(2);
      document.getElementById('totalProducts').textContent = totalProducts.toFixed(2);
    }

    function exportToExcel() {
      alert('Export to Excel feature coming soon!');
    }

    function getCurrentUserRole() {
      const token = localStorage.getItem('token');
      if (!token) return null;
      const payload = JSON.parse(atob(token.split('.')[1]));
      return payload.role;
    }

    function editLog(logId) {
      const log = allLogs.find(l => l.id === logId);
      if (!log) {
        alert('Log not found');
        return;
      }

      // Redirect to edit page with log data
      alert('Edit functionality: Redirect to LawnMowing.html with pre-filled data coming soon!');
      // TODO: Implement edit modal or redirect to form with pre-filled data
    }

    async function deleteLog(logId) {
      if (!confirm('Are you sure you want to delete this log? This cannot be undone.')) return;

      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE_URL}/green-logs/${logId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          alert('Log deleted successfully!');
          await fetchLogs();
        } else {
          const error = await response.json();
          alert(`Failed to delete log: ${error.detail || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Error deleting log:', error);
        alert('Failed to delete log. Check console.');
      }
    }

    function checkAccess(allowedRoles) {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/static/login.html';
        return;
      }
      const payload = JSON.parse(atob(token.split('.')[1]));
      const role = payload.role;
      if (!allowedRoles.includes(role)) {
        alert("Access denied.");
        window.location.href = '/static/login.html';
      }
    }
  </script>
</body>
</html>
